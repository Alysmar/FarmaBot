<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FarmaBot</title>
    <!--Vinculando con Google Fonts Icons-->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
    />
    <!-- Vinculando con la hoja de estilos CSS -->
    <link rel="stylesheet" type="text/css" href="css/farmabot.css" />
  </head>

  <body>
    <div class="container">
      <!--Barra lateral-->
      <div class="sidebar">
        <h1>Farmabot</h1>
        <!-- Botón para iniciar un nuevo chat -->
        <div class="new-chat-btn">
          <button class="new-chat">
            <span class="material-symbols-outlined">add</span>
            <text>Nuevo chat</text>
          </button>
        </div>
        <h2>Recientes</h2>
        <!-- Lista de chats recientes -->
        <div class="action-buttons">
          <ul id="chat-list"></ul>
        </div>
        <!-- Botón para cerrar sesión -->
        <div class="logout-btn">
          <button>Cerrar sesión</button>
        </div>
      </div>

      <!-- Contenido principal -->
      <div class="content">
        <!--Área de lectura del chat-->
        <div id="chat-output">
          <header class="header">
            <!--Saludo-->
            <h2 class="title">Hola</h2>
            <h4 class="subtitle">¿En que puedo ayudarte hoy?</h4>
          </header>

          <!--Indicador de carga-->
           <div class="loading-indicator">
              <div class="loading-animation-1"></div>
              <div class="loading-animation-2"></div>
              <div class="loading-animation-3"></div>
           </div>
        </div>
        
        <!--Area de escritura-->
        <div id="chat-input" class="typing-area">
          <form action="#" class="typing-form">
            <div class="input-area">
              <input
                type="text"
                id="user-input"
                placeholder="Escribe aquí tu requerimiento..."
                class="typing-input"
              />
              <button id="send-button">Enviar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

        <script type="importmap">
        {
          "imports": {
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
          }
        }
      </script>

      <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // Obtener referencias a elementos del DOM
        const newChatButton = document.querySelector(".new-chat-btn button");
        const chatList = document.getElementById("chat-list");
        const chatContainer = document.querySelector(".content");
        const chatOutput = document.getElementById("chat-output");
        const userInput = document.getElementById("user-input");
        const sendButton = document.getElementById("send-button");

        // Array para almacenar las instancias de chat
        let chatInstances = [];

        // Inicializar la API de Google Generative AI
        const API_KEY = "AIzaSyAdWi5CUaD3SlOM51TEvxn7IHfFSRhqN3Q"; // Reemplaza con tu clave de API
        const genAI = new GoogleGenerativeAI(API_KEY);

        // Event listener para el botón "Enviar"
        sendButton.addEventListener("click", async () => {
          // Obtener el mensaje del usuario
          const userMessage = userInput.value;
          userInput.value = ""; // Limpiar el campo de entrada

          // Mostrar el mensaje del usuario en el chat
          displayMessage("Usted", userMessage, "user-message");

          // Obtener el modelo de lenguaje
          const model = genAI.getGenerativeModel({
            model: "gemini-1.5-pro-latest",
          });
          const prompt = userMessage;

          // Mostrar la animación de carga
          const loadingIndicator = document.querySelector(".loading-indicator");
          loadingIndicator.style.display = "block";

          try {
            // Generar la respuesta del chatbot
            const result = await model.generateContent(prompt);
            const response = await result.response;

            // Ocultar la animación de carga
            loadingIndicator.style.display = "none";

            // Mostrar la respuesta del chatbot en el chat
            displayMessage("Farmabot", response.text(), "bot-message");
          } catch (error) {
            // Manejar errores
            console.error("Error al generar contenido:", error);
            displayMessage("Farmabot", "Error al procesar tu solicitud.", "bot-message");
          }
        });

        // Event listener para el botón "Nuevo Chat"
        newChatButton.addEventListener("click", () => {
          // Crear un nuevo div para el chat
          const newChat = document.createElement("div");
          newChat.classList.add("chat");
          chatContainer.appendChild(newChat);

          // Agregar el chat a la lista de chats recientes
          const chatItem = document.createElement("li");
          chatItem.textContent = `Chat ${chatInstances.length + 1}`;
          chatList.appendChild(chatItem);

          // Agregar el nuevo chat al array de instancias
          chatInstances.push(newChat);

          // Agregar botón de eliminar
          const deleteButton = document.createElement("button");
          deleteButton.classList.add("material-symbols-outlined", "delete-button");
          deleteButton.innerHTML = "delete";
          chatItem.appendChild(deleteButton);
          chatList.appendChild(chatItem);
          chatInstances.push(newChat); // Agregar de nuevo al array (posible error)

          // Aquí puedes implementar la lógica para iniciar una nueva conversación con la IA
        });

        // Función para mostrar un mensaje en el chat
        function displayMessage(sender, message, messageClass) {
          const messageElement = document.createElement("p");
          messageElement.innerHTML = `<strong>${sender}</strong><br>${message}`;
          messageElement.classList.add(messageClass);
          chatOutput.appendChild(messageElement);
          chatOutput.scrollTop = chatOutput.scrollHeight; // Desplazarse al final del chat
        }

        // Función para eliminar un chat
        function removeChat(chatIndex) {
          chatList.children[chatIndex].remove(); // Eliminar de la lista de chats
          chatInstances[chatIndex].remove(); // Eliminar del contenedor
          chatInstances.splice(chatIndex, 1); // Eliminar del array de instancias
        }

        // Event listener para los botones de eliminar
        document.addEventListener("click", (event) => {
          if (event.target.classList.contains("delete-button")) {
            const chatIndex = Array.from(chatList.children).indexOf(event.target.parentNode);
            removeChat(chatIndex);
          }
        });
      </script>

        <!--<script src="js/farmabot.js"></script>-->
      </div>
    </div>
  </body>
</html>
